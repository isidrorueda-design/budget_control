<div class="contextual">
  <%= link_to 'Nueva Estimación', new_bc_estimate_path(project_id: @project), class: 'icon icon-add' if User.current.allowed_to?(:manage_budget_control, @project) %>
  <%= link_to 'Importar', '#', class: 'icon icon-upload', onclick: "$('#import-dialog').dialog('open'); return false;" if User.current.allowed_to?(:manage_budget_control, @project) %>
  <%= link_to 'Exportar', export_bc_estimates_path(project_id: @project, format: :xlsx), class: 'icon icon-download' %>
</div>

<h2>Estimaciones</h2>

<%= form_tag(bc_estimates_path(project_id: @project), method: :get, class: 'query-form') do %>
  <fieldset>
    <legend><%= l(:label_filter_plural) %></legend>
    <div class="splitcontent">
      <div class="splitcontentleft">
        <p>
          <%= label_tag 'contractor_id', 'Contratista' %>
          <%= select_tag 'contractor_id',
                         options_from_collection_for_select(@contractor_for_select, :id, :name, params[:contractor_id]),
                         prompt: 'Todos',
                         onchange: "this.form.submit();" %>
        </p>
      </div>
      <div class="splitcontentright">
        <p>
          <%= label_tag 'contract_id', 'Contrato' %>
          <%= select_tag 'contract_id',
                         options_from_collection_for_select(@contracts_for_select, :id, :number, params[:contract_id]),
                         prompt: 'Todos' %>
        </p>
      </div>
    </div>
    <p class="buttons">
      <%= link_to l(:button_apply), '#', onclick: '$(this).closest("form").submit()', class: 'icon icon-checked' %>
      <%= link_to l(:button_clear), bc_estimates_path(project_id: @project), class: 'icon icon-reload' %>
    </p>
  </fieldset>
<% end %>

<div class="autoscroll">
  <table class="list">
    <thead>
      <tr>
        <th style="text-align: left;">Contratista</th>
        <th style="text-align: left;">Contrato</th>
        <th style="text-align: left;">No. Estimación</th>
        <th style="text-align: left;">Fecha</th>
        <th style="text-align: left;">Monto Estimado</th>
        <th style="text-align: left;">Amortizado</th>
        <th style="text-align: left;">Fondo Garantía</th>
        <th style="text-align: left;">Retenciones</th>
        <th style="text-align: left;">Deductivas</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% @estimates.each do |estimate| %>
        <tr class="entry <%= cycle('odd', 'even') %>">
          <td style="text-align: left;"><%= estimate.contractor.name %></td>
          <td style="text-align: left;"><%= estimate.contract.number %></td>
          <td style="text-align: left;"><%= estimate.estimate_num %></td>
          <td style="text-align: left;"><%= format_date(estimate.estimate_date) %></td>
          <td style="text-align: left;">$<%= number_to_currency(estimate.estimated, unit: "", separator: ".", delimiter: ",") %></td>
          <td style="text-align: left;">$<%= number_to_currency(estimate.amortized, unit:  "", separator: ".", delimiter: ",") %></td>
          <td style="text-align: left;">$<%= number_to_currency(estimate.warranty_fund, unit:  "", separator: ".", delimiter: ",") %></td>
          <td style="text-align: left;">$<%= number_to_currency(estimate.retentions, unit:  "", separator: ".", delimiter: ",") %></td>
          <td style="text-align: left;">$<%= number_to_currency(estimate.deductive, unit:  "", separator: ".", delimiter: ",") %></td>
          <td class="buttons">
            <%= link_to 'Editar', edit_bc_estimate_path(estimate, project_id: @project), class: 'icon icon-edit' if User.current.allowed_to?(:manage_budget_control, @project) %>
            <%= link_to 'Eliminar', bc_estimate_path(estimate, project_id: @project), method: :delete, data: { confirm: '¿Estás seguro?' }, class: 'icon icon-del' if User.current.allowed_to?(:manage_budget_control, @project) %>
          </td>
        </tr>
      <% end %>
      <% if @estimates.empty? %>
        <tr>
          <td colspan="10" class="nodata"><%= l(:label_no_data) %></td>
        </tr>
      <% end %>
    </tbody>
    <tfoot>
      <tr class="total">
        <td colspan="4" style="text-align: right; font-weight: bold;">Totales:</td>
        <td style="text-align: left; font-weight: bold;"><%= number_to_currency(@totals[:estimated], unit: '$') %></td>
        <td style="text-align: left; font-weight: bold;"><%= number_to_currency(@totals[:amortized], unit: '$') %></td>
        <td style="text-align: left; font-weight: bold;"><%= number_to_currency(@totals[:warranty_fund], unit: '$') %></td>
        <td style="text-align: left; font-weight: bold;"><%= number_to_currency(@totals[:retentions], unit: '$') %></td>
        <td style="text-align: left; font-weight: bold;"><%= number_to_currency(@totals[:deductive], unit: '$') %></td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>

<% if User.current.allowed_to?(:manage_budget_control, @project) %>
<div id="import-dialog" title="Importar Estimaciones" style="display:none;">
  <%= form_tag(import_bc_estimates_path(project_id: @project), multipart: true) do %>
    <p>
      <%= label_tag 'file', 'Selecciona un archivo XLSX' %><br>
      <%= file_field_tag 'file', accept: '.xlsx' %>
    </p>
    <p>
      El archivo debe contener las columnas: <strong>contrato, estimacion, monto estimado</strong>, fecha, amortizado, fondo de garantia, retenciones, deductivas.
    </p>
    <div class="buttons">
      <%= submit_tag 'Importar', class: 'button-positive' %>
    </div>
  <% end %>
</div>
<script>
  $(function() {
    $("#import-dialog").dialog({ autoOpen: false, modal: true, width: 500 });
  });
</script>
<% end %>